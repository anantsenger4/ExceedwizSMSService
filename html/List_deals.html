<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
	<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=0.1">
        <meta charset="utf-8">
	 	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.7/handlebars.js"></script>
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css " />
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<script type="text/javascript" src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
        <script type="text/javascript" src="../js/ZohoEmbededAppSDK.min15.js"></script>
	<style>
	    .select2-selection{
		height: 60px !important;
		overflow-y: auto;
	    }
	</style>
	
	<script>
        
        $(document).ready(function(){
            
            var recordId;
	        var TopupUrl;
            var recordId;
	    	var TopupUrl;
			var username;
			var password;
			var msgfrom;
			var dlr_url;
			var suc_var = "";
			var err_var = "";
            
            ZOHO.embeddedApp.init().then(function(){
               
                
            });
            
            /* Define functin to find and replace specified term with replacement string */
            
            function escapeRegExp(string){

                return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            }
            
            function replaceAll(str, term, replacement) {
            
                return str.replace(new RegExp(escapeRegExp(term), 'g'), replacement);
            }
            
            
            $("#send_message").click(function(){
                
                var suc_count = 0;
				var err_count = 0;
				
				var loop_count = 0;
				var record_count = $("#rec_count").val();
		
				$('#to_name :selected').each(function(){
					
					var data_id = $(this).val();
					var data_arr = data_id.split('_');
					var record_id = data_arr[0];
					var entity_name = data_arr[1];
					var dealid = data_arr[2];
		    
                    ZOHO.CRM.API.getRecord({Entity:entity_name,RecordID:record_id})
                    .then(function(data){
                        
                        var msgContent = $("#message").val();
			
                        $.each( data, function( field_name, field_value ) {
			
						if (field_value === null){
						
						field_value = "";
						
						} else if (Object.prototype.toString.call(field_value) === '[object Object]') {
						
						field_value = "";
						}
			    
						var find = "["+field_name+"]";
						msgContent = replaceAll( msgContent, find, field_value);
			    
					});
                        
                        // Sening SMS and Message to the Account
                        var mobile_number;
						var phone_field = $("#phone_field").val();
						switch (phone_field) { 
							case 'Phone': 
								mobile_number = data.Phone;
								break;
							case 'Mobile': 
								mobile_number = data.Mobile;
								break;
							case 'Home_Phone': 
								mobile_number = data.Home_Phone;
								break;
							case 'Other_Phone': 
								mobile_number = data.Other_Phone;
								break;
							case 'Asst_Phone': 
								mobile_number = data.Asst_Phone;
								break;
							default:
								mobile_number = data.Phone;
						}
                        
                        if (mobile_number != '') {
							var mobile_number_without_space = mobile_number.replace(/ /g, "");
							var mobile_number_without_space = mobile_number.replace(/-/g, "");
							mobile_number = mobile_number_without_space;
						}
			
						console.log(mobile_number);
                        console.log(msgContent);
                        
						if( (msgContent != "") && (mobile_number != "") ){
                            
                            var username="AC277d8052c3c6379399c938590605a36f";
			    			var password="8c2d4363c15a4e81262392439a24a2c1";
			     	
							console.log(msgContent);
		     				console.log(mobile_number);
			   				 $.ajax({
						      type: "POST",
						      url: "https://api.twilio.com/2010-04-01/Accounts/AC277d8052c3c6379399c938590605a36f/Messages.json",
						      headers: {
						   			 "Authorization": "Basic " + btoa(username + ":" + password)
						   			 },
						      data: {
						        "To" : mobile_number,
						        "From" : "+12028164979",
						        "Body" : msgContent
						      },
						      success: function(data) {
						        console.log(data);
						      },
						      error: function(data) {
						        console.log(data);
						      }
						    });
                            
                            ZOHO.CRM.HTTP.get(request).then(function(data){
				
								console.log(data);
								var new_resp = "";
								if( data != "" )
								{
									new_resp = data.substr(0,data.indexOf(" ") + 1).trim();
								}
								console.log(new_resp);
								if( new_resp == "Success"  )
								{
									suc_var = "Success";
									suc_count++;
								}else
								{
									err_var = "Error";
									err_count++;
								}

								console.log("Success var: "+suc_var);
								console.log("Error var: "+err_var);
				
								// Adding the info into SMS Sent module	
								if( ( suc_var == "Success" ) ){
								
									ZOHO.CRM.API.getAllRecords({Entity:"Potentials",RecordID:dealid}).then(function(data){
							
										var msgContentSent = $("#message").val().trim();
										var deal_name = data.Deal_Name;
										var deal_id = data.id;
										var dealData = {name: deal_name, id: deal_id};
										
										var temp_text = $('#template_list').find('option:selected').val();
										var temp_val = $('#template_list').val();
										var data_arr = temp_text.split('|');
										var temp_id = data_arr[1];
										
										if (temp_id !== undefined) {
											var tempdata = {name: temp_val, id: temp_id};
											var recordData = {"Name":"Deals Bulk SMS","SMS_Message":msgContent,"Deal_Name":dealData,"SMS_Sent_To":mobile_number,"SMS_Template":tempdata};
										}else{
											var recordData = {"Name":"Deals Bulk SMS","SMS_Message":msgContent,"Deal_Name":dealData,"SMS_Sent_To":mobile_number};
										}
										
										ZOHO.CRM.API.insertRecord({Entity:"s2sms2__SMS_Sent",APIData:recordData}).then(function(data){
											console.log(data);
										});
									});
									
								}
				
								// Display the information messages
								if( loop_count == record_count ){
									
									console.log("Success count: "+suc_count);
									console.log("Error count: "+err_count);
									
									if( ( err_count == 0) && ( suc_count > 0) ){
									
									$('#msg_suc').slideDown(function() {
										
										$('#msg_suc').html("<strong>Success!</strong> "+suc_count+" Messages Sent");
										$('#msg_suc').delay(6000).slideUp(function() {
										//ZOHO.CRM.UI.Popup.close();
										});
									});
									}
									
									if( ( err_count > 0) && ( suc_count == 0) ){
										$('#msg_error').slideDown(function() {
											
											$('#msg_error').html("<strong>Error!</strong> "+err_count+" "+jsobj.error);
											$('#msg_error').delay(6000).slideUp();
											
										});
									}
									
									if( ( err_count > 0) && ( suc_count > 0) ){
									
									var err_msg = "<strong>Error!</strong> "+err_count+" Invalid Recipients";
									var suc_msg = "<strong>Success!</strong> "+suc_count+" Messages Sent";
									
									$('#msg_suc').slideDown(function() {
										$('#msg_suc').html(suc_msg);
										$('#msg_suc').delay(6000).slideUp();
									});
									
									/*
									$('#msg_error').slideDown(function() {
										$('#msg_error').html(err_msg);
										$('#msg_error').delay(6000).slideUp();
									});
									*/
									}
									
								}
				
                            });
                            
                        }
                        
                    });
		    
                    loop_count++;
                });
                
            });
            
            // Snippet to insert the fields in Message
            jQuery.fn.extend({
                insertAtCaret: function(myValue){
                  return this.each(function(i) {
                    if (document.selection) {
                      //For browsers like Internet Explorer
                      this.focus();
                      sel = document.selection.createRange();
                      sel.text = myValue;
                      this.focus();
                    }
                    else if (this.selectionStart || this.selectionStart == '0') {
                      //For browsers like Firefox and Webkit based
                      var startPos = this.selectionStart;
                      var endPos = this.selectionEnd;
                      var scrollTop = this.scrollTop;
                      this.value = this.value.substring(0, startPos)+myValue+this.value.substring(endPos,this.value.length);
                      this.focus();
                      this.selectionStart = startPos + myValue.length;
                      this.selectionEnd = startPos + myValue.length;
                      this.scrollTop = scrollTop;
                    } else {
                      this.value += myValue;
                      this.focus();
                    }
                  })
                }
            });
            
            $("#insert_field").change(function(){
                
		if ( $("#insert_field").val() != '' ) {
		    
		    var field_val = '['+$("#insert_field").val()+']';
		    $("#message").insertAtCaret(field_val);
		}
                
            });
	    
	    $('#message').keyup(function () {
		
		var one_credit = 160;
		var len = $(this).val().length;
		$('#chr_count').text(len);
		
		var to_count = 0;
		$('#to_name :selected').each(function(){
		    to_count++;
		});
		
		var credit = Math.ceil(len / one_credit);
		$('#credit_count').text( credit * to_count );
		
	    });
            
        });
        
        
        ZOHO.embeddedApp.on("PageLoad",function(data){
            
            ZOHO.CRM.UI.Resize({height:"550",width:"500"}).then(function(data){
		    console.log(data);
	    });
	    
	    var load_count = 0;
	    
	    var record_count = data.EntityId.length;
	    $("#rec_count").val(record_count);
	    
            var users_str = '';
            
            for (var id in data.EntityId) {
                
                $("#phone_loading").show();
		
		ZOHO.CRM.API.getRecord({Entity:data.Entity,RecordID:data.EntityId[id]})
                .then(function(data){
                    
                    //console.log(data.id);
		    var dealid = data.id;
		    var contact_id = data.Contact_Name.id;
		    var account_id = data.Account_Name.id;
		    
		    ZOHO.CRM.API.getRecord({Entity:"Contacts",RecordID:contact_id})
		    .then(function(data){
			
			var contact_phone = data.Phone;
			
			if ( contact_phone !== null ){
			
			    var optval = data.id+'_Contacts_'+dealid;
			    users_str += '<option value="'+optval+'" selected="selected" >'+data.Full_Name+'</option>';
			    $("#to_name").html(users_str);
			    
			}else{
			    
			    ZOHO.CRM.API.getRecord({Entity:"Accounts",RecordID:account_id})
			    .then(function(data){
				
				var optval = data.id+'Accounts';
				users_str += '<option value="'+optval+'" selected="selected" >'+data.Account_Name+'</option>';
				$("#to_name").html(users_str);
			
			    })
			}
		    })
                    
                });
		
				load_count++;
				$("#phone_loading").html(load_count+" Contacts Loading..");
            }
	    
	    if (record_count == load_count) {
		    var delay_time = record_count * 500;
            $("#phone_loading").delay(delay_time).slideUp();
	    }
	    
            // Getting fields from Account module
                
            ZOHO.CRM.META.API.getFields({"Entity":"Contacts"}).then(function(data){
                
                var phone_field_str = '<option value="">Phone Fields</option>';
		var fields_str = '<option value="">Insert Fields</option>';
                
                $.each(data.fields, function( arr_key, arr_value ) {
                    
                    fields_str += '<option value="'+arr_value.api_name+'">'+arr_value.field_label+'</option>';
                    $("#insert_field").html(fields_str);
		    
		    if( arr_value.data_type == 'phone' ) {
			phone_field_str += '<option value="'+arr_value.api_name+'">'+arr_value.field_label+'</option>';
			$("#phone_field").html(phone_field_str);
		    }
                    
                });
                
            });
            
        });

        </script>
    </head>
    <body> 

            <div class="container" style="margin-top: 50px;">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3" >
                    <form  action="" method="post" enctype="multipart/form-data" onsubmit="return validate();">
                        
                        <div style="display: none;" class="form-group col-sm-12 alert alert-success" id="msg_suc" role="alert"></div>
			<div style="display: none;" class="form-group col-sm-12 alert alert-danger" id="msg_error" role="alert"></div>
            	<h2 style="color: #008FDE; text-align:center; margin: 0px; margin-bottom: 20px;">Exceedwiz Messaging Application</h2>
                        
                        <div class='form-group col-sm-12' >
                                <p style="margin: 0px !important;" ><label style="color: #008FDE;">To</label></p>
                                <select style="width: 640px !important;height: 60px; border: 0.01px solid #1B96D7;" name="to_name" class="form-control" id="to_name" multiple ></select>
				<p><span id="phone_loading">Contacts Loading...</span></p>
                        </div>
                        
                        
                        <div class='form-group col-sm-12' >
                                
                                <div class="row" style="padding-top: 10px;">
                                    <div class="col-xs-4"><select name="phone_field" class="form-control" id="phone_field"><option value="">Phone Fields</option></select></div>
                                    <div class="col-xs-4 col-xs-offset-4" style="padding-bottom: 10px !important;" ><select name="insert_field" class="form-control" id="insert_field"><option value="">Insert Fields</option></select></div>
                                </div>
                                
				<label style="color: #008FDE;">Message</label>
				<textarea class="form-control" row="50" col="35" name="message" id="message" maxlength="160" placeholder="Your Message" style="border: 0.01px solid #1B96D7;"></textarea>
				
                        </div>
			
			<input type="hidden" name="rec_count" id="rec_count" value="" />
			
			<div class='form-group col-sm-12'style="text-align: center;" >     
                            <span id="topup_btn"><span>
			    <button type="button" class="btn btn-group btn-primary " name="send_message" id="send_message" value="Send Message" >Send Message</button>     
                        </div>
                        
                    </form>
                </div>    
            </div>
        </div>
            
        
            
    </body>   
</html>            